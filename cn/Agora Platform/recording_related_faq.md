
---
title: 录制相关
description: 
platform: 录制相关
updatedAt: Thu Nov 01 2018 08:09:12 GMT+0000 (UTC)
---
# 录制相关
# 录制相关

## 权限

#### 怎么检测录音权限？

* iOS/macOS 平台上: 首次运行系统会提示打开录音权限。如被手工关闭后开发者可以查询系统接口 AVAudioSession.sharedInstance().recordPermission()[iOS8.0+] 来检测录音权限。
* Android 平台上: 比较复杂，因为各个厂家的实现不一，并没有统一的手段可以检测到所有手机的录音权限。Agora Native SDK 会尝试检测录音失败并且上报 ERR_ADM_RECORD_AUDIO_FAILED (1018) 错误码，但未必能覆盖所有机型。

你的 App 可以通过此上报错误码来提示用户检测录音权限。

#### 音视频通话时我可以录音吗？

我们提供录音功能，可以通过 API 将录音文件直接存储到开发者指定的服务器上。

## 录制方案

#### 我到底该用哪一种录制方案, 录制 SDK, 录制服务，还是 CDN 直播录制?

推荐所有的新用户使用录制 SDK 版，其他方案均已被弃用。

## 从录制服务迁移到录制 SDK

#### 我还需要在 Dashboard 后台配置 ARS IP 吗？

不需要。

#### 我还需要使用 Recording Key 才能录制吗？

不需要。

#### 录制的触发是由 Linux 服务器控制的吗？

是的。

#### 我还需要调用 API startRecordingService 开始录制吗？

不需要。

#### 由于服务器自己触发录制，那它怎么知道什么时候加入频道，频道号等？

通过你自己的信令。
当录制 SDK 加入频道时，API 的行为与客户端使用 Agora Native SDK 调用 API 的行为类似。

## 录制 SDK

### 开始录制后，为什么没有录制文件？

请检查 `appId` 设置的是否与客户端使用 Agora Native SDK 时设置的一样。
请检查 `channelProfile` 的模式是否与客户端使用 Agora Native SDK 设置的一样。例如，录制的设为直播模式，Agora Native SDK 设置通信模式，直播和通信模式的视频无法互通，因此不会有录制文件。

### 录制结束后，为什么检查录制的视频没有声音？

录制的音视频文件为独立的，视频为 mp4 格式文件，语音为 aac 格式文件。视频文件本身不含语音，你需要手动转码将多个音视频文件合并成一个文件。

### 录制结束后，为什么无法播放录制的 MP4 文件？

* 1.1 版本之前: 请使用录制软件包内的转码工具进行转码，转码后可以播放录制的 MP4 文件
* 1.1 版本之后: 如果调用了 `setVideoMixingLayout` 后是可以直接播放录制文件的，如果没有调用该 API， 请使用录制软件包内的转码工具进行转码，转码后可以播放录制的 MP4 文件

### 启用加密模式后，为什么无法播放录制的视频文件，声音也不正常？

启用加密模式后，如果密码输入不正确或者没有输入密码，录制的文件无法播放。

由于语音被加密了，导致声音不正常。

### 当我将加密密码设置地跟客户端一样时，为什么录制仍然不成功？

请确保加密参数与客户端设置的一样，小写的 aes-128-xts 或 aes-256-xts 。

### 客户端和服务器端使用相同的 appId，为什么没有录制文件?

当你在服务器端调用 API `joinChannel`，设置 `channelProfile` 参数时，请将频道模式设置的与客户端设置的一样。例如:
当客户端设为直播模式，录制服务器端设为通信模式，加入频道后，直播模式与通信模式无法互通，因此没有录制文件。

### 如何使用 Channel Key?

详见 [Channel Key 密钥说明](../../cn/Agora%20Platform/channel_key.md)。

#### 当启用混音模式之后，为什么只有一个 uid 为 0 的录制文件？

这是默认的设计，当启用混音模式后，多个用户加入频道，所有人的语音会被录制在同一个文件里，uid 为 0 。

### 当我拖动录制文件的进度条时，为什么会出现花屏或绿屏现象？

这是默认的设计，你需要将录制的视频文件进行转码，不然拖动进度条，就会出现花屏或绿屏现象。

### 当录制失败时，是否有回调提醒，例如: 服务器掉线，录制进程卡住了等？

从 1.1 版开始支持回调提醒。

### 没有回调，如何通知录制程序离开频道？

从 1.1 开始提供该功能，之前的版本通过以下方式通知录制程序：

1. Linux 服务器通过你自己的信令通知录制程序离开频道，停止录制。
2. 录制 SDK 调用 `leaveChannel` 。离开频道后，会生成一个 `recording2_done.txt` 文件。

### 没有回调，如何通知应用程序某用户已离线？

当频道里没有任何人的时间超过你在调用 `joinChannel` 时设置的 `idleLimitSec` 时长时，录制自动停止。录制停止后，出生成一个 `recording2_done.txt` 文件。

### 如何对录制文件进行转码?

关于如何手动对录制文件进行转码，详见 [录制音视频](../../cn/Quickstart%20Guide/recording_voice_video.md)。
如果出现问题，请联系客户支持分析和定位问题。

### 我可以自己设置录制文件的路径和文件名？

你可以自己设置录制文件的根目录，但是自己无法命名。详见 [录制音视频](../../cn/Quickstart%20Guide/recording_voice_video.md)。

### 如何保证同时录制的频道数没有超过服务器容量(CPU/内存)?

请参考文档 [录制音视频](../../cn/Quickstart%20Guide/recording_voice_video.md)。

### 如何预估生成的录制文件大小？

每路视频录制文件默认配置为 400 kbps 。实际文件大小跟录制的内容和环境有关。

### 目前仅支持 C++ 语言，什么时候可以支持其他语言？

目前仅支持 C++ 语言，同时你也可以通过命令行启用录制功能。

### 为什么我通过命令行设置 "--appId = f4637604af81440596a54254d53ade20 --uid = 222 --channel = ttt" ，显示设置无效？

不支持 *=*. 正确的格式为:
--appId f4637604af81440596a54254d53ade20 --uid 222 --channel ttt

### 为什么客户端可以登录，而录制程序登陆不上去（录制程序可以发包，但是却收不到来自agora服务器的包）？

录制程序随机挑选一个端口与 Agora 服务器进行通信，若运行录制程序的环境对端口有限制，可能会造成连接不上。

如果需要指定端口，解决方法是在可执行程序的相同目录下，写一个配置文件 `agorasdk.json`，内容格式如下：

端口数字可以更改，但端口号范围 high - low >= 4
agorasdk.json
{ "rtc.udp_port_range": [ 40000, 40004 ] }

这种方法仅支持一个频道的录制。如果支持多个频道的录制，还是建议服务器环境不要对 UDP 端口做限制。

### 当使用命令行进行录制时，什么时候停止录制?

当使用命令行进行录制时，会在以下情况下停止录制：

* 在命令行运行时，在键盘上同时按下 Ctrl 和 C 键
* 当你设置参数 idle(设置空闲频道超时退出时间) 的值后，如果频道内无用户超过设定的时间，录制程序自动退出。默认值为 300 秒

### 可以指定只录某个用户的音视频么?

暂时不支持。

### 我如何知道程序是正常退出频道，还是异常退出频道?

如果是正常退出频道，首先 SDK 会触发 onLeaveChanne，并会返回错误码 ERR_INTERNAL_FAILED = 3。
如果是异常退出频道，SDK 不会触发 onLeaveChannel，而是触发 onError 并返回错误码 ERR_INTERNAL_FAILED = 3 。

### 录制文件转码后的格式是什么?
详见 [录制音视频](../../cn/Quickstart%20Guide/recording_voice_video.md)。

### 使用命令行时，只输入默认的 must 参数，为何启动不了录制程序？

在输入 `--appliteDir` 参数时，只需指到 **video_recorder** 文件夹，不要指到 **video_recorder** 这个文件。

### 为什么录制并转码完成后的视频，在播放的时候，视频前面会黑一小段？

可能的原因如下：

* 网络不好；
* 视频包 I 帧收到之后，才会创建视频录制，在此之前收到其他 B,P 帧会丢掉；
* 视频包的每一帧都比音频的大，所以音频包通常都会比视频包先收到并开启录制；

### 能录制旋转的视频吗？

录制 SDK 仅保存从 Client 端传来的视频。在生成 mp4 文件时，SDK 会根据 `uid_xxx.txt` 文件中的信息对视频旋转一次。因此无论视频在录制过程中旋转几次，录制 SDK 只会按 `uid_xxx.txt` 文件中的第一个旋转信息进行旋转。你可以根据 `uid_xxx.txt` 文件的旋转信息自己修改转码脚本，然后得到旋转后的视频。目前计划在 2.3 版本中加入使用转码脚本进行视频旋转的功能。

### 录制文件夹下没有生成录制文件

* 录制进程没有成功加入到频道

   检查Argus频道内，录制客户端是否在频道里，如果没有，说明录制加入频道失败。常见原因有：录制的 appid 不对、频道号不  对、开启了app certificate但是没有携带 channelKey 或 channelKey 不对，通过检查录制日志 recording_sys.log 里的 -appID，–channel，–channelKey 参数可进行判断

（录制客户端在 Argus 里可以通过 Role 和 SDK 判断，注意区分1.12版本的为推流服务器，1.14、2.0.0 及以上版本为录制服务器）

![](https://web-cdn.agora.io/docs-files/1540451989525)

* 加入的频道内没有 Native/Web 用户 
  
	检查 Argus 频道，需要至少有一个 Native/Web 用户，如果只有录制客户端，则无法录到文件。

  如果频道里有用户，需要检查用户是否有发流，如果没有发流录制也是不会生成文件的。

### 录制出来的文件时长不对

* 检查 argus 时长，是否和实际生成的文件长度不一致，如果不一致，让客户提供此次录制文件夹下的 `recording_sys.log`
* 对比音视频时长，是否同一用户的音频和视频长度不一致。如果不一致，让客户提供此次录制文件夹下的的 `recording_sys.log`、对应用户的音视频录制文件、`uid_*******.txt` 文件

### 录制结束之后只有音频文件，没有视频文件

* 这种情况多出现在 Native/Web 和录制的通信模式不一致导致，检查 Argus的 SDK Client Role 即可
* 如果通信模式一致，检查客户端发送的视频情况、录制端收流情况：Video Receive Bitrate、Video Decoder In/Out Frame Rate、ARS Received H264 Frame Num
* 如果以上都正常，收集 r`ecording_sys.log`

### 录制出来的视频，打开播放黑屏，但是声音正常

这种现象多是客户使用的播放器不被支持，可以参考我们的播放器支持列表。

![](https://web-cdn.agora.io/docs-files/1540452122894)

### 录制退出报错

如出现 Error: 3, with stat_code:16 报错时，录制属于正常退出。通过 leave_path code 判断录制退出的原因。

![](https://web-cdn.agora.io/docs-files/1540452150871)

* LEAVE_CODE_INIT(0)：初始化失败
* LEAVE_CODE_SIG(1<<1)：由信号触发的退出
* LEAVE_CODE_NO_USERS(1<<2)：频道内除录制外，没有其他用户
* LEAVE_CODE_TIMER_CATCH(1<<3)：捕获到信号错误
* LEAVE_CODE_CLIENT_LEAVE(1<<4)：wrapper 层主动退出

> 日志里的 code 为上面括号内 2 进制移位后的 10 进制数。比如，(1<<1)=2; (1<<2)=4。所以上面的 leave channel with code:12是由 (1<<2)=4 + (1<<3) =8 得来的。

一般都是频道内没有用户，录制正常退出了。检查 recording_sys.log，是否有 "No users in channel" 的关键字即可确认。

### 录制出来的视频倒置

这种情况，往往都是被录制用户的 rotation 做了切换导致的（横屏时左右切换180度，切换前后摄像头）。由于 native 客户端会自动对 rotation 信息作旋转，所以 native 客户端看到的都是正的。录制 2.2 版本之前，by design 不会自动旋转，2.3 版本会加入自动旋转的功能。

2.0 以前版本，uid_xxx.txt 文件不会有 rotation 的实时信息，只有第一次的记录
2.0~2.2 版本，加入 rotation 信息的实时信息在 `uid_xxx.txt`，可以通过 uid 文件的 rotation 信息自己处理视频
2.3 版本，会加入自动旋转功能

### 如何判断录制是否 crash

* 视频文件无法播放
* `uid****.txt` 文件最后有没有 mp4 文件的 close 信息
* `recording_sys.log` 里面有 MediaFile 关键字，但是没有 ~MediaFile 的关键字
* argus 里录制的 event 信息里最后没有 Quit
以上几个如果同时出现几个，可以判断是录制 crash 了


### 录制出来的文件，音画不同步怎么办

* 音频速度正常，视频速度很快，属于已知问题，更新到 2.1.1 之后的版本都可以解决
* 集中的很多次录制都不同步，检查录制服务器的 CPU 是不是很高，VOQA 数据是不是异常，这类问题会导致不同步，需要客户调整网络或者服务器并发录制数量
* 偶现的一两次不同步，或进频道 15 s 内偶现的不同步，这种目前的版本无法解决，需要 2.3 版本的 AVsyncMode，同时配合客户端升级 2.3 才能解决。

### 录制文件出现切片

* 可能是 Native/Web 和录制的通信模式不一致导致。
* 频道内同时有 Native/Web 端时，可能是 Native 端没有开启互通 enableWebSdkInteroperability 导致的。
