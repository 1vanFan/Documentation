
---
title: 云端录制集成最佳实践
description: 
platform: All Platforms
updatedAt: Tue Sep 01 2020 10:42:40 GMT+0800 (CST)
---
# 云端录制集成最佳实践
为了保障录制服务的可靠性，Agora 建议你在集成云端录制 RESTful API 时注意以下几点：

## 使用双域名

<div class="alert note">双域名方法只适用于中国大陆。非中国大陆地区仅支持域名 <code>api.agora.io</code>。</div>

如果你使用域名 `api.agora.io` 发起 RESTful API 请求失败，可以先用该域名重试一次；如再次失败，可将域名替换为 `api.agoraio.cn`，再次发送请求。建议使用退避策略，如第一次等待 1 秒后重试、第二次等待 3 秒后重试、第三次等待 6 秒后重试，以免超过每秒请求数（QPS）限制导致失败。

## 确认录制服务已成功启动

建议你通过如下步骤确认录制服务已成功启动：

1. 确认 `start` 请求成功，即成功获得 `sid` (录制 ID)。如果 `start` 请求失败，需要根据状态码采取相应措施：
   - 如果返回的 HTTP 状态码为 `40x`，则表示请求参数错误，需要进行排查。
   - 如果返回的 HTTP 状态码为 `50x`，可使用相同的参数重试多次，直到成功返回 `sid` 为止。建议使用退避策略，如第一次等待 3 秒后重试、第二次等待 6 秒后重试、第三次等待 9 秒后重试，以免超过 QPS 限制导致失败。如果三次重试均失败，建议更换 UID 再次调用 `acquire`， 获得一个新的 resource ID，并用该 resource ID 再次调用 `start` 方法。
2. 获得 `sid` 之后的 5 秒后，使用退避策略调用 `query` 方法，退避间隔建议小于 `start` 请求中的 `maxIdleTime` (最长空闲频道时间)。如果 `query` 请求成功，且 `serverResponse` 中的 `status` 参数值为 `4` 或 `5`，则表示录制服务已成功启动。如果在获得 `sid` 之后的 90 秒后 `status` 仍非 `4` 或 `5`， 则可以认为录制未启动或成功后超时退出。

<div class="alert note">建议你准备一个备份 UID，在重新启动录制时使用，以避免频道内两个相同 UID 互踢。主备 UID 可以交替使用。</div>

## 录制过程中的服务状态监控

你可以通过周期性调用 `query` 来确认录制服务正在进行中且状态正常。如果 `query` 请求失败，需要根据状态码采取相应措施：

- 如果返回的 HTTP 状态码一直为 `40x`，则表示请求参数错误，需要进行排查。
- 如果返回的 HTTP 状态码为 `404`，且已经确认请求参数无误，则表示录制并未成功启动、或启动后中途退出。建议采用退避策略多次调用 `query` （例如间隔 5 秒、10 秒、15 秒）进行确认。
- 如果返回的 HTTP 状态码为 `50x`，则表示 `query` 请求失败，但尚不明确录制是否已退出。出现 `50x` 错误的概率极小，建议使用退避策略 (例如间隔5 秒、10 秒、15 秒、30 秒) 继续调用 `query`。

## 获取 M3U8 文件名

获取 M3U8 文件名有两种方式，一种是按照文件命名规则拼接，另一种是通过 `query` 来查询。Agora 推荐通过拼接的方式获取文件名。

### 通过 `query` 请求获得 M3U8 文件的文件名

M3U8 文件名是第一份切片文件生成后产生的，所以需要在第一次切片完成后查询。详见[切片规则](https://docs.agora.io/cn/cloud-recording/cloud_recording_manage_files#切片规则)。

合流录制模式下，建议在成功开启云端录制 15 秒后调用 `query` 查询 M3U8 文件名；单流录制模式下，建议在成功开启云端录制 1 分钟后调用 `query` 查询 M3U8 文件名。如果第一次查询失败，可以在 1 分钟后重试。

### 按照文件命名规则拼接 

合流录制模式下，M3U8 文件名的格式为 `<sid>_<cname>.m3u8`。因此，你还可以通过拼接的方式获取 M3U8 文件名。详见[录制文件命名规则](https://docs.agora.io/cn/cloud-recording/cloud_recording_manage_files#合流模式)。

## 避免录制服务频繁退出

`start` 方法中的 `maxIdleTime` 参数默认值为 30 秒。如果实际场景中主播频繁上下线，过短的 `maxIdleTime` 会导致录制服务频繁退出。对于要求录制服务一直在频道中的场景，需要加大 `maxIdleTime`，避免因频道内短时间无发流端导致的录制退出。

举例来说，如果每堂课中固定有 5 分钟的休息时间，则可以将 `maxIdleTime` 设置为 10 分钟，保证整堂课的录制不中断。

